<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.independent documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.1.7</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-2 branch current"><a href="jepsen.independent.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2 branch"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-2 branch"><a href="jepsen.tests.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.independent.html#var-checker"><div class="inner"><span>checker</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-concurrent-generator"><div class="inner"><span>concurrent-generator</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-dir"><div class="inner"><span>dir</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-history-keys"><div class="inner"><span>history-keys</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-sequential-generator"><div class="inner"><span>sequential-generator</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-subhistory"><div class="inner"><span>subhistory</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-tuple"><div class="inner"><span>tuple</span></div></a></li><li class="depth-1"><a href="jepsen.independent.html#var-tuple.3F"><div class="inner"><span>tuple?</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.independent</h1><div class="doc"><div class="markdown"><p>Some tests are expensive to check–for instance, linearizability–which requires we verify only short histories. But if histories are short, we may not be able to sample often or long enough to reveal concurrency errors. This namespace supports splitting a test into independent components–for example taking a test of a single register and lifting it to a <em>map</em> of keys to registers.</p></div></div><div class="public anchor" id="var-checker"><h3>checker</h3><div class="usage"><code>(checker checker)</code></div><div class="doc"><div class="markdown"><p>Takes a checker that operates on :values like <code>v</code>, and lifts it to a checker that operates on histories with values of <code>[k v]</code> tuples–like those generated by <code>sequential-generator</code>.</p>
<p>We partition the history into (count (distinct keys)) subhistories. The subhistory for key k contains every element from the original history <em>except</em> those whose values are MapEntries with a different key. This means that every history sees, for example, un-keyed nemesis operations or informational logging.</p>
<p>The checker we build is valid iff the given checker is valid for all subhistories. Under the :results key we store a map of keys to the results from the underlying checker on the subhistory for that key. :failures is the subset of that :results map which were not valid.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L246">view source</a></div></div><div class="public anchor" id="var-concurrent-generator"><h3>concurrent-generator</h3><div class="usage"><code>(concurrent-generator n keys fgen)</code></div><div class="doc"><div class="markdown"><p>Takes a positive integer n, a sequence of keys (k1 k2 …) and a function (fgen k) which, when called with a key, yields a generator. Returns a generator which runs tests on independent keys concurrently, with n threads per key. Once a key’s generator is exhausted, it obtains a new key, constructs a new generator from key, and moves on.</p>
<p>The nemesis does not run in subgenerators; only normal workers evaluate these operations.</p>
<p>The concurrency model may change; I’m not sure what the best way to do it is.</p>
<p>One strategy is to divide the set of processes into n groups, and have each group focus on one key. This might interact poorly with <code>gen/reserve</code>, which limits some processe to specific generators. We can still run with gen/reserve, but users will have to know that if their concurrency is, say, 100 and they have n=10, then <em>inside</em> an independent generator they only have 10 threads to work with. We also can’t have n &gt; concurrency, because there wouldn’t be enough processes, and realistically you want a process for each node minimum, so concurrency=100 with 5 nodes could run twenty keys at most.</p>
<p>Another tactic is to have each process cycle through the various active keys. This is <em>safe</em>, because once the checker strains through the history, each subhistory consists of the full set of processes doing what it should. We can also move to arbitrarily high concurrencies. What concerns me is <em>timing</em>: if one key does an expensive operation, it’s gonna prevent <em>any other</em> key from scheduling an op on that process until it comes back. This could mask latency anomalies in a subhistory, because some processes won’t even be <em>making</em> requests when they’re tied up working on other keys. We could, I think, possibly miss concurrency errors by having processes stuck doing other keys work, and we can’t give you feedback that the test’s resolving power has been compromised. Things like <code>delay</code> would have to be rewritten to take into account process/thread timesharing.</p>
<p>Worse yet, imagine we use an inter-process synchronizer, e.g. gen/phases. Then the second strategy could actually <em>deadlock</em>.</p>
<p>I would rather not write my own thread scheduler, so, we’re gonna do the first strategy and keep using the Java synchronization primitives. We’ll split the process set into n distinct pools. Contiguous, because Jepsen stripes processes across nodes mod node-count. Generators inside will run with a reduced test :concurrency, and with a rebound value of gen/*threads*, so barriers work independently for each key.</p>
<p>I think this coupling is kinda gross and suggests a fundamental rewrite of jepsen.core and the generator implementation might be needed.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L65">view source</a></div></div><div class="public anchor" id="var-dir"><h3>dir</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>What directory should we write independent results to?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L16">view source</a></div></div><div class="public anchor" id="var-history-keys"><h3>history-keys</h3><div class="usage"><code>(history-keys history)</code></div><div class="doc"><div class="markdown"><p>Takes a history and returns the set of keys in it.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L221">view source</a></div></div><div class="public anchor" id="var-sequential-generator"><h3>sequential-generator</h3><div class="usage"><code>(sequential-generator keys fgen)</code></div><div class="doc"><div class="markdown"><p>Takes a sequence of keys (k1 k2 …), and a function (fgen k) which, when called with a key, yields a generator. Returns a generator which starts with the first key k1 and constructs a generator gen1 from (fgen k1). Returns elements from gen1 until it is exhausted, then moves to k2.</p>
<p>The generator wraps each :value in the operations it generates. Let (:value (op gen1)) be v; then the generator we construct yields the kv tuple [k1 v].</p>
<p>fgen must be pure and idempotent.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L30">view source</a></div></div><div class="public anchor" id="var-subhistory"><h3>subhistory</h3><div class="usage"><code>(subhistory k history)</code></div><div class="doc"><div class="markdown"><p>Takes a history and a key k and yields the subhistory composed of all ops in history which do not have values with a differing key, unwrapping tuples to their original values.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L233">view source</a></div></div><div class="public anchor" id="var-tuple"><h3>tuple</h3><div class="usage"><code>(tuple k v)</code></div><div class="doc"><div class="markdown"><p>Constructs a kv tuple</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L20">view source</a></div></div><div class="public anchor" id="var-tuple.3F"><h3>tuple?</h3><div class="usage"><code>(tuple? value)</code></div><div class="doc"><div class="markdown"><p>Is the given value generated by an independent generator?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.7/jepsen/src/jepsen/independent.clj#L25">view source</a></div></div></div></body></html>