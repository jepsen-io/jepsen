<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.db.watchdog documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.3.10</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1"><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.plot.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>plot</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.clj-ssh.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-ssh</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.docker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>docker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.k8s.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>k8s</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.retry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>retry</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.scp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scp</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.sshj.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sshj</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-3 current"><a href="jepsen.db.watchdog.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>watchdog</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.fs-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs-cache</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></div></li><li class="depth-3"><a href="jepsen.generator.interpreter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interpreter</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2 branch"><a href="jepsen.lazyfs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazyfs</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.file.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>file</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.membership.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>membership</span></div></a></li><li class="depth-4"><a href="jepsen.nemesis.membership.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.role.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>role</span></div></a></li><li class="depth-2"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-3 branch"><a href="jepsen.store.format.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>format</span></div></a></li><li class="depth-3"><a href="jepsen.store.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4 branch"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-4"><a href="jepsen.tests.cycle.wr.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wr</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.kafka.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.db.watchdog.html#var-db"><div class="inner"><span>db</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-disable.21"><div class="inner"><span>disable!</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-enable.21"><div class="inner"><span>enable!</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-kill.21"><div class="inner"><span>kill!</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-locking"><div class="inner"><span>locking</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-run.21"><div class="inner"><span>run!</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-step.21"><div class="inner"><span>step!</span></div></a></li><li class="depth-1"><a href="jepsen.db.watchdog.html#var-watchdog"><div class="inner"><span>watchdog</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.db.watchdog</h1><div class="doc"><div class="markdown"><p>Databases often like to crash, and they may not restart themselves automatically,  which means we have to do it for them. This creates the possibility of all kinds of race conditions. This namespace provides a watchdog which runs in a thread for the duration of the test, and a <code>DB</code> wrapper for unreliable DBs.</p>
<p>Watchdogs know whether the server they supervise is <em>running</em>. They can be <em>enabled</em> or <em>disabled</em>, which determines whether they restart the server or not. They can be <em>killed</em> once, which destroys their thread. They can also be locked, during which the watchdog takes no actions.</p>
</div></div><div class="public anchor" id="var-db"><h3>db</h3><div class="usage"><code>(db opts db)</code></div><div class="doc"><div class="markdown"><p>Wraps an existing database in a one with watchdogs for each node. Takes a map of partial options to <code>watchdog</code> (just :running? and :interval), and a DB to wrap. Uses <code>db/start!</code> to start the database. Ensures that db/kill! and db/start! disable and enable the watchdog.</p>
<p>The DB you wrap must implement the full suite of DB protocols–LogFiles, Primary, etc. This is a little awkward, but feels preferable to having a zillion variants of the DB class here. You can generally return <code>nil</code> from (e.g.) log-files, primaries, etc., and Jepsen will do sensible things.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L180">view source</a></div></div><div class="public anchor" id="var-disable.21"><h3>disable!</h3><div class="usage"><code>(disable! w)</code></div><div class="doc"><div class="markdown"><p>Informs the watchdog that it should not restart the daemon. Returns once we can guarantee the watchdog won’t restart.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L21">view source</a></div></div><div class="public anchor" id="var-enable.21"><h3>enable!</h3><div class="usage"><code>(enable! w)</code></div><div class="doc"><div class="markdown"><p>Informs the watchdog that it should restart the daemon. Returns immediately.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L21">view source</a></div></div><div class="public anchor" id="var-kill.21"><h3>kill!</h3><div class="usage"><code>(kill! w)</code></div><div class="doc"><div class="markdown"><p>Kills the watchdog, terminating its thread. Blocks until complete.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L21">view source</a></div></div><div class="public anchor" id="var-locking"><h3>locking</h3><h4 class="type">macro</h4><div class="usage"><code>(locking watchdog &amp; body)</code></div><div class="doc"><div class="markdown"><p>Locks a Watchdog for the duration of body. Use this around any of your code that starts/stops the server, to avoid race conditions where you e.g. kill the server and the watchdog immediately restarts it.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L131">view source</a></div></div><div class="public anchor" id="var-run.21"><h3>run!</h3><div class="usage"><code>(run! w test node)</code></div><div class="doc"><div class="markdown"><p>Starts the mainloop, calling step! repeatedly. Returns watchdog immediately.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L21">view source</a></div></div><div class="public anchor" id="var-step.21"><h3>step!</h3><div class="usage"><code>(step! w test node)</code></div><div class="doc"><div class="markdown"><p>The main step of the watchdog. Periodically invoked by the runner.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L21">view source</a></div></div><div class="public anchor" id="var-watchdog"><h3>watchdog</h3><div class="usage"><code>(watchdog {:keys [running? start!], :as opts})</code></div><div class="doc"><div class="markdown"><p>Creates a new Watchdog for a single node. Takes an options map with:</p>
<pre><code>{:running?  A function (running? test node) which returns true iff the
            server is running.
 :start!    A function (start! test node) which starts the server.
 :interval  Time, in ms, between checking to restart the server.
            Default 1000.}
</code></pre>
<p>Both running? and start? are evaluated with a jepsen.control connection bound to the given node.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.10/jepsen/src/jepsen/db/watchdog.clj#L108">view source</a></div></div></div></body></html>