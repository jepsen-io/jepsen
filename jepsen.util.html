<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.util documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.1.11</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch current"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -176px;"><span class="top" style="height: 185px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.util.html#var-*relative-time-origin*"><div class="inner"><span>*relative-time-origin*</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-all-jdk-loggers"><div class="inner"><span>all-jdk-loggers</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-buf-size"><div class="inner"><span>buf-size</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-chunk-vec"><div class="inner"><span>chunk-vec</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-coll"><div class="inner"><span>coll</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-compare.3C"><div class="inner"><span>compare&lt;</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-concat-files.21"><div class="inner"><span>concat-files!</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-drop-common-proper-prefix"><div class="inner"><span>drop-common-proper-prefix</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-exception.3F"><div class="inner"><span>exception?</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-fast-last"><div class="inner"><span>fast-last</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-fcatch"><div class="inner"><span>fcatch</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-fraction"><div class="inner"><span>fraction</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-history-.3Elatencies"><div class="inner"><span>history-&gt;latencies</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-inc*"><div class="inner"><span>inc*</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-integer-interval-set-str"><div class="inner"><span>integer-interval-set-str</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-lazy-atom"><div class="inner"><span>lazy-atom</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-letr"><div class="inner"><span>letr</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-letr-let-if"><div class="inner"><span>letr-let-if</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-letr-partition-bindings"><div class="inner"><span>letr-partition-bindings</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-letr-rewrite-return"><div class="inner"><span>letr-rewrite-return</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-linear-time-nanos"><div class="inner"><span>linear-time-nanos</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-local-time"><div class="inner"><span>local-time</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-log"><div class="inner"><span>log</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-log-op"><div class="inner"><span>log-op</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-log-print"><div class="inner"><span>log-print</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-logger"><div class="inner"><span>logger</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-longest-common-prefix"><div class="inner"><span>longest-common-prefix</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-majority"><div class="inner"><span>majority</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-map-keys"><div class="inner"><span>map-keys</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-map-kv"><div class="inner"><span>map-kv</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-map-vals"><div class="inner"><span>map-vals</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-max-by"><div class="inner"><span>max-by</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-maybe-number"><div class="inner"><span>maybe-number</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-meh"><div class="inner"><span>meh</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-min-by"><div class="inner"><span>min-by</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-ms-.3Enanos"><div class="inner"><span>ms-&gt;nanos</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-mute"><div class="inner"><span>mute</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-mute-jdk"><div class="inner"><span>mute-jdk</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-name.2B"><div class="inner"><span>name+</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-nanos-.3Ems"><div class="inner"><span>nanos-&gt;ms</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-nanos-.3Esecs"><div class="inner"><span>nanos-&gt;secs</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-nemesis-intervals"><div class="inner"><span>nemesis-intervals</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-op-.3Estr"><div class="inner"><span>op-&gt;str</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-poly-compare"><div class="inner"><span>poly-compare</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-polysort"><div class="inner"><span>polysort</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-pprint-str"><div class="inner"><span>pprint-str</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-print-history"><div class="inner"><span>print-history</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-prn-op"><div class="inner"><span>prn-op</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-processors"><div class="inner"><span>processors</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-pwrite-history.21"><div class="inner"><span>pwrite-history!</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-rand-nth-empty"><div class="inner"><span>rand-nth-empty</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-random-nonempty-subset"><div class="inner"><span>random-nonempty-subset</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-real-pmap"><div class="inner"><span>real-pmap</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-relative-time-nanos"><div class="inner"><span>relative-time-nanos</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-retry"><div class="inner"><span>retry</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-secs-.3Enanos"><div class="inner"><span>secs-&gt;nanos</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-sequential"><div class="inner"><span>sequential</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-sleep"><div class="inner"><span>sleep</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-spy"><div class="inner"><span>spy</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-time-"><div class="inner"><span>time-</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-timeout"><div class="inner"><span>timeout</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-with-relative-time"><div class="inner"><span>with-relative-time</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-with-retry"><div class="inner"><span>with-retry</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-with-thread-name"><div class="inner"><span>with-thread-name</span></div></a></li><li class="depth-1"><a href="jepsen.util.html#var-write-history.21"><div class="inner"><span>write-history!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.util</h1><div class="doc"><div class="markdown"><p>Kitchen sink</p></div></div><div class="public anchor" id="var-*relative-time-origin*"><h3>*relative-time-origin*</h3><h4 class="dynamic">dynamic</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L276">view source</a></div></div><div class="public anchor" id="var-all-jdk-loggers"><h3>all-jdk-loggers</h3><div class="usage"><code>(all-jdk-loggers)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L227">view source</a></div></div><div class="public anchor" id="var-buf-size"><h3>buf-size</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L128">view source</a></div></div><div class="public anchor" id="var-chunk-vec"><h3>chunk-vec</h3><div class="usage"><code>(chunk-vec n v)</code></div><div class="doc"><div class="markdown"><p>Partitions a vector into reducibles of size n (somewhat like partition-all) but uses subvec for speed.</p>
<pre><code>(chunk-vec 2 [1])     ; =&gt; ([1])
(chunk-vec 2 [1 2 3]) ; =&gt; ([1 2] [3])
</code></pre></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L117">view source</a></div></div><div class="public anchor" id="var-coll"><h3>coll</h3><div class="usage"><code>(coll thing-or-things)</code></div><div class="doc"><div class="markdown"><p>Wraps non-coll things into singleton lists, and leaves colls as themselves. Useful when you can take either a single thing or a sequence of things.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L581">view source</a></div></div><div class="public anchor" id="var-compare.3C"><h3>compare&lt;</h3><div class="usage"><code>(compare&lt; a b)</code></div><div class="doc"><div class="markdown"><p>Like &lt;, but works on any comparable objects, not just numbers.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L511">view source</a></div></div><div class="public anchor" id="var-concat-files.21"><h3>concat-files!</h3><div class="usage"><code>(concat-files! out fs)</code></div><div class="doc"><div class="markdown"><p>Appends contents of all fs, writing to out. Returns fs.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L130">view source</a></div></div><div class="public anchor" id="var-drop-common-proper-prefix"><h3>drop-common-proper-prefix</h3><div class="usage"><code>(drop-common-proper-prefix cs)</code></div><div class="doc"><div class="markdown"><p>Given a collection of sequences, removes the longest common proper prefix from each one.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L668">view source</a></div></div><div class="public anchor" id="var-exception.3F"><h3>exception?</h3><div class="usage"><code>(exception? x)</code></div><div class="doc"><div class="markdown"><p>Is x an Exception?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L20">view source</a></div></div><div class="public anchor" id="var-fast-last"><h3>fast-last</h3><div class="usage"><code>(fast-last coll)</code></div><div class="doc"><div class="markdown"><p>Like last, but O(1) on counted collections.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L86">view source</a></div></div><div class="public anchor" id="var-fcatch"><h3>fcatch</h3><div class="usage"><code>(fcatch f)</code></div><div class="doc"><div class="markdown"><p>Takes a function and returns a version of it which returns, rather than throws, exceptions.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L25">view source</a></div></div><div class="public anchor" id="var-fraction"><h3>fraction</h3><div class="usage"><code>(fraction a b)</code></div><div class="doc"><div class="markdown"><p>a/b, but if b is zero, returns unity.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L97">view source</a></div></div><div class="public anchor" id="var-history-.3Elatencies"><h3>history-&gt;latencies</h3><div class="usage"><code>(history-&gt;latencies history)</code></div><div class="doc"><div class="markdown"><p>Takes a history–a sequence of operations–and emits the same history but with every invocation containing two new keys:</p>
<p>:latency the time in nanoseconds it took for the operation to complete. :completion the next event for that process</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L598">view source</a></div></div><div class="public anchor" id="var-inc*"><h3>inc*</h3><div class="usage"><code>(inc* x)</code></div><div class="doc"><div class="markdown"><p>Like inc, but (inc nil) =&gt; 1.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L104">view source</a></div></div><div class="public anchor" id="var-integer-interval-set-str"><h3>integer-interval-set-str</h3><div class="usage"><code>(integer-interval-set-str set)</code></div><div class="doc"><div class="markdown"><p>Takes a set of integers and yields a sorted, compact string representation.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L528">view source</a></div></div><div class="public anchor" id="var-lazy-atom"><h3>lazy-atom</h3><div class="usage"><code>(lazy-atom f)</code></div><div class="doc"><div class="markdown"><p>An atom with lazy state initialization. Calls (f) on first use to provide the initial value of the atom. Only supports swap/reset/deref. Reset bypasses lazy initialization. If f throws, behavior is undefined (read: proper fucked).</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L680">view source</a></div></div><div class="public anchor" id="var-letr"><h3>letr</h3><h4 class="type">macro</h4><div class="usage"><code>(letr bindings &amp; body)</code></div><div class="doc"><div class="markdown"><p>Let bindings, plus early return.</p>
<p>You want to do some complicated, multi-stage operation assigning lots of variables–but at different points in the let binding, you need to perform some conditional check to make sure you can proceed to the next step. Ordinarily, you’d intersperse let and if statements, like so:</p>
<pre><code>(let [res (network-call)]
  (if-not (:ok? res)
    :failed-network-call

    (let [people (:people (:body res))]
      (if (zero? (count people))
        :no-people

        (let [res2 (network-call-2 people)]
          ...
</code></pre>
<p>This is a linear chain of operations, but we’re forced to nest deeply because we have no early-return construct. In ruby, we might write</p>
<pre><code>res = network_call
return :failed_network_call if not x.ok?

people = res[:body][:people]
return :no-people if people.empty?

res2 = network_call_2 people
...
</code></pre>
<p>which reads the same, but requires no nesting thanks to Ruby’s early return. Clojure’s single-return is <em>usually</em> a boon to understandability, but deep linear branching usually means something like</p>
<ul>
  <li>Deep nesting (readability issues)</li>
  <li>Function chaining (lots of arguments for bound variables)</li>
  <li>Throw/catch (awkward exception wrappers)</li>
  <li>Monadic interpreter (slow, indirect)</li>
</ul>
<p>This macro lets you write:</p>
<pre><code>(letr [res    (network-call)
       _      (when-not (:ok? res) (return :failed-network-call))
       people (:people (:body res))
       _      (when (zero? (count people)) (return :no-people))
       res2   (network-call-2 people)]
  ...)
</code></pre>
<p>letr works like let, but if (return x) is ever returned from a binding, letr returns x, and does not evaluate subsequent expressions.</p>
<p>If something other than (return x) is returned from evaluating a binding, letr binds the corresponding variable as normal. Here, we use _ to indicate that we’re not using the results of (when …), but this is not mandatory. You cannot use a destructuring bind for a return expression.</p>
<p>letr is not a <em>true</em> early return–(return x) must be a <em>terminal</em> expression for it to work–like (recur). For example,</p>
<pre><code>(letr [x (do (return 2) 1)]
  x)
</code></pre>
<p>returns 1, not 2, because (return 2) was not the terminal expression.</p>
<p>return only works within letr’s bindings, not its body.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L423">view source</a></div></div><div class="public anchor" id="var-letr-let-if"><h3>letr-let-if</h3><div class="usage"><code>(letr-let-if groups body)</code></div><div class="doc"><div class="markdown"><p>Takes a sequence of binding groups and a body expression, and emits a let for the first group, an if statement checking for a return, and recurses; ending with body.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L405">view source</a></div></div><div class="public anchor" id="var-letr-partition-bindings"><h3>letr-partition-bindings</h3><div class="usage"><code>(letr-partition-bindings bindings)</code></div><div class="doc"><div class="markdown"><p>Takes a vector of bindings [sym expr, sym’ expr, …]. Returns binding-groups: a sequence of vectors of bindgs, where the final binding in each group has an early return. The final group (possibly empty!) contains no early return.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L385">view source</a></div></div><div class="public anchor" id="var-letr-rewrite-return"><h3>letr-rewrite-return</h3><div class="usage"><code>(letr-rewrite-return expr)</code></div><div class="doc"><div class="markdown"><p>Rewrites (return x) to (Return. x) in expr. Returns a pair of [changed? expr], where changed is whether the expression contained a return.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L367">view source</a></div></div><div class="public anchor" id="var-linear-time-nanos"><h3>linear-time-nanos</h3><div class="usage"><code>(linear-time-nanos)</code></div><div class="doc"><div class="markdown"><p>A linear time source in nanoseconds.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L271">view source</a></div></div><div class="public anchor" id="var-local-time"><h3>local-time</h3><div class="usage"><code>(local-time)</code></div><div class="doc"><div class="markdown"><p>Drops millisecond resolution</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L111">view source</a></div></div><div class="public anchor" id="var-log"><h3>log</h3><div class="usage"><code>(log &amp; things)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L218">view source</a></div></div><div class="public anchor" id="var-log-op"><h3>log-op</h3><div class="usage"><code>(log-op op)</code></div><div class="doc"><div class="markdown"><p>Logs an operation and returns it.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L208">view source</a></div></div><div class="public anchor" id="var-log-print"><h3>log-print</h3><div class="usage"><code>(log-print _ &amp; things)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L215">view source</a></div></div><div class="public anchor" id="var-logger"><h3>logger</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L214">view source</a></div></div><div class="public anchor" id="var-longest-common-prefix"><h3>longest-common-prefix</h3><div class="usage"><code>(longest-common-prefix cs)</code></div><div class="doc"><div class="markdown"><p>Given a collection of sequences, finds the longest sequence which is a prefix of every sequence given.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L653">view source</a></div></div><div class="public anchor" id="var-majority"><h3>majority</h3><div class="usage"><code>(majority n)</code></div><div class="doc"><div class="markdown"><p>Given a number, returns the smallest integer strictly greater than half.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L59">view source</a></div></div><div class="public anchor" id="var-map-keys"><h3>map-keys</h3><div class="usage"><code>(map-keys f m)</code></div><div class="doc"><div class="markdown"><p>Maps keys in a map.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L501">view source</a></div></div><div class="public anchor" id="var-map-kv"><h3>map-kv</h3><div class="usage"><code>(map-kv f m)</code></div><div class="doc"><div class="markdown"><p>Takes a function (f [k v]) which returns [k v], and builds a new map by applying f to every pair.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L495">view source</a></div></div><div class="public anchor" id="var-map-vals"><h3>map-vals</h3><div class="usage"><code>(map-vals f m)</code></div><div class="doc"><div class="markdown"><p>Maps values in a map.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L506">view source</a></div></div><div class="public anchor" id="var-max-by"><h3>max-by</h3><div class="usage"><code>(max-by f coll)</code></div><div class="doc"><div class="markdown"><p>Finds the maximum element of a collection based on some (f element), which returns Comparables. If <code>coll</code> is empty, returns nil.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L75">view source</a></div></div><div class="public anchor" id="var-maybe-number"><h3>maybe-number</h3><div class="usage"><code>(maybe-number s)</code></div><div class="doc"><div class="markdown"><p>Tries reading a string as a long, then double, then string. Passes through nil. Useful for getting nice values out of stats APIs that just dump a bunch of heterogenously-typed strings at you.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L569">view source</a></div></div><div class="public anchor" id="var-meh"><h3>meh</h3><h4 class="type">macro</h4><div class="usage"><code>(meh &amp; body)</code></div><div class="doc"><div class="markdown"><p>Returns, rather than throws, exceptions.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L555">view source</a></div></div><div class="public anchor" id="var-min-by"><h3>min-by</h3><div class="usage"><code>(min-by f coll)</code></div><div class="doc"><div class="markdown"><p>Finds the minimum element of a collection based on some (f element), which returns Comparables. If <code>coll</code> is empty, returns nil.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L64">view source</a></div></div><div class="public anchor" id="var-ms-.3Enanos"><h3>ms-&gt;nanos</h3><div class="usage"><code>(ms-&gt;nanos ms)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L263">view source</a></div></div><div class="public anchor" id="var-mute"><h3>mute</h3><h4 class="type">macro</h4><div class="usage"><code>(mute &amp; body)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L258">view source</a></div></div><div class="public anchor" id="var-mute-jdk"><h3>mute-jdk</h3><h4 class="type">macro</h4><div class="usage"><code>(mute-jdk &amp; body)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L234">view source</a></div></div><div class="public anchor" id="var-name.2B"><h3>name+</h3><div class="usage"><code>(name+ x)</code></div><div class="doc"><div class="markdown"><p>Tries name, falls back to pr-str.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L39">view source</a></div></div><div class="public anchor" id="var-nanos-.3Ems"><h3>nanos-&gt;ms</h3><div class="usage"><code>(nanos-&gt;ms nanos)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L265">view source</a></div></div><div class="public anchor" id="var-nanos-.3Esecs"><h3>nanos-&gt;secs</h3><div class="usage"><code>(nanos-&gt;secs nanos)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L269">view source</a></div></div><div class="public anchor" id="var-nemesis-intervals"><h3>nemesis-intervals</h3><div class="usage"><code>(nemesis-intervals history)</code></div><div class="doc"><div class="markdown"><p>Given a history where a nemesis goes through :f :start and :f :stop transitions, constructs a sequence of pairs of :start and :stop ops. Since a nemesis usually goes :start :start :stop :stop, we construct pairs of the first and third, then second and fourth events. Where no :stop op is present, we emit a pair like [start nil].</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L634">view source</a></div></div><div class="public anchor" id="var-op-.3Estr"><h3>op-&gt;str</h3><div class="usage"><code>(op-&gt;str op)</code></div><div class="doc"><div class="markdown"><p>Format an operation as a string.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L146">view source</a></div></div><div class="public anchor" id="var-poly-compare"><h3>poly-compare</h3><div class="usage"><code>(poly-compare a b)</code></div><div class="doc"><div class="markdown"><p>Comparator function for sorting heterogenous collections.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L516">view source</a></div></div><div class="public anchor" id="var-polysort"><h3>polysort</h3><div class="usage"><code>(polysort coll)</code></div><div class="doc"><div class="markdown"><p>Sort, but on heterogenous collections.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L523">view source</a></div></div><div class="public anchor" id="var-pprint-str"><h3>pprint-str</h3><div class="usage"><code>(pprint-str x)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L304">view source</a></div></div><div class="public anchor" id="var-print-history"><h3>print-history</h3><div class="usage"><code>(print-history history)</code><code>(print-history printer history)</code></div><div class="doc"><div class="markdown"><p>Prints a history to the console.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L167">view source</a></div></div><div class="public anchor" id="var-prn-op"><h3>prn-op</h3><div class="usage"><code>(prn-op op)</code></div><div class="doc"><div class="markdown"><p>Prints an operation to the console.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L156">view source</a></div></div><div class="public anchor" id="var-processors"><h3>processors</h3><div class="usage"><code>(processors)</code></div><div class="doc"><div class="markdown"><p>How many processors on this platform?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L54">view source</a></div></div><div class="public anchor" id="var-pwrite-history.21"><h3>pwrite-history!</h3><div class="usage"><code>(pwrite-history! f history)</code><code>(pwrite-history! f printer history)</code></div><div class="doc"><div class="markdown"><p>Writes history, taking advantage of more cores.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L184">view source</a></div></div><div class="public anchor" id="var-rand-nth-empty"><h3>rand-nth-empty</h3><div class="usage"><code>(rand-nth-empty coll)</code></div><div class="doc"><div class="markdown"><p>Like rand-nth, but returns nil if the collection is empty.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L91">view source</a></div></div><div class="public anchor" id="var-random-nonempty-subset"><h3>random-nonempty-subset</h3><div class="usage"><code>(random-nonempty-subset nodes)</code></div><div class="doc"><div class="markdown"><p>A randomly selected, randomly ordered, non-empty subset of the given collection.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L33">view source</a></div></div><div class="public anchor" id="var-real-pmap"><h3>real-pmap</h3><div class="usage"><code>(real-pmap f coll)</code></div><div class="doc"><div class="markdown"><p>Like pmap, but launches futures instead of using a bounded threadpool.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L46">view source</a></div></div><div class="public anchor" id="var-relative-time-nanos"><h3>relative-time-nanos</h3><div class="usage"><code>(relative-time-nanos)</code></div><div class="doc"><div class="markdown"><p>Time in nanoseconds since <em>relative-time-origin</em></p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L285">view source</a></div></div><div class="public anchor" id="var-retry"><h3>retry</h3><h4 class="type">macro</h4><div class="usage"><code>(retry dt &amp; body)</code></div><div class="doc"><div class="markdown"><p>Evals body repeatedly until it doesn’t throw, sleeping dt seconds.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L324">view source</a></div></div><div class="public anchor" id="var-secs-.3Enanos"><h3>secs-&gt;nanos</h3><div class="usage"><code>(secs-&gt;nanos s)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L267">view source</a></div></div><div class="public anchor" id="var-sequential"><h3>sequential</h3><div class="usage"><code>(sequential thing-or-things)</code></div><div class="doc"><div class="markdown"><p>Wraps non-sequential things into singleton lists, and leaves sequential things or nil as themselves. Useful when you can take either a single thing or a sequence of things.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L589">view source</a></div></div><div class="public anchor" id="var-sleep"><h3>sleep</h3><div class="usage"><code>(sleep dt)</code></div><div class="doc"><div class="markdown"><p>High-resolution sleep; takes a (possibly fractional) time in ms.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L290">view source</a></div></div><div class="public anchor" id="var-spy"><h3>spy</h3><div class="usage"><code>(spy x)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L307">view source</a></div></div><div class="public anchor" id="var-time-"><h3>time-</h3><h4 class="type">macro</h4><div class="usage"><code>(time- &amp; body)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L298">view source</a></div></div><div class="public anchor" id="var-timeout"><h3>timeout</h3><h4 class="type">macro</h4><div class="usage"><code>(timeout millis timeout-val &amp; body)</code></div><div class="doc"><div class="markdown"><p>Times out body after n millis, returning timeout-val.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L311">view source</a></div></div><div class="public anchor" id="var-with-relative-time"><h3>with-relative-time</h3><h4 class="type">macro</h4><div class="usage"><code>(with-relative-time &amp; body)</code></div><div class="doc"><div class="markdown"><p>Binds <em>relative-time-origin</em> at the start of body.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L279">view source</a></div></div><div class="public anchor" id="var-with-retry"><h3>with-retry</h3><h4 class="type">macro</h4><div class="usage"><code>(with-retry initial-bindings &amp; body)</code></div><div class="doc"><div class="markdown"><p>It’s really fucking inconvenient not being able to recur from within (catch) expressions. This macro wraps its body in a (loop [bindings] (try …)). Provides a (retry &amp; new bindings) form which is usable within (catch) blocks: when this form is returned by the body, the body will be retried with the new bindings.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L339">view source</a></div></div><div class="public anchor" id="var-with-thread-name"><h3>with-thread-name</h3><h4 class="type">macro</h4><div class="usage"><code>(with-thread-name thread-name &amp; body)</code></div><div class="doc"><div class="markdown"><p>Sets the thread name for duration of block.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L560">view source</a></div></div><div class="public anchor" id="var-write-history.21"><h3>write-history!</h3><div class="usage"><code>(write-history! f history)</code><code>(write-history! f printer history)</code></div><div class="doc"><div class="markdown"><p>Writes a history to a file.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.11/jepsen/src/jepsen/util.clj#L175">view source</a></div></div></div></body></html>