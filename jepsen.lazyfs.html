<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.lazyfs documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.3.2</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.clj-ssh.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clj-ssh</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.docker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>docker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.k8s.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>k8s</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.retry.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>retry</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.scp.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>scp</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.sshj.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>sshj</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -300px;"><span class="top" style="height: 309px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2 branch"><a href="jepsen.fs-cache.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fs-cache</span></div></a></li><li class="depth-2"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.context.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>context</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.interpreter.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interpreter</span></div></a></li><li class="depth-3 branch"><a href="jepsen.generator.test.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>test</span></div></a></li><li class="depth-3"><a href="jepsen.generator.translation-table.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>translation-table</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2 branch current"><a href="jepsen.lazyfs.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>lazyfs</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.membership.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>membership</span></div></a></li><li class="depth-4"><a href="jepsen.nemesis.membership.state.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-3 branch"><a href="jepsen.store.format.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>format</span></div></a></li><li class="depth-3"><a href="jepsen.store.fressian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fressian</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4 branch"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-4"><a href="jepsen.tests.cycle.wr.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>wr</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.kafka.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>kafka</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -331px;"><span class="top" style="height: 340px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.lazyfs.html#var-bin"><div class="inner"><span>bin</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-checkpoint.21"><div class="inner"><span>checkpoint!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-commit"><div class="inner"><span>commit</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-config"><div class="inner"><span>config</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-db"><div class="inner"><span>db</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-dir"><div class="inner"><span>dir</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-fifo.21"><div class="inner"><span>fifo!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-fuse-dev"><div class="inner"><span>fuse-dev</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-install.21"><div class="inner"><span>install!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-lazyfs"><div class="inner"><span>lazyfs</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-lose-unfsynced-writes.21"><div class="inner"><span>lose-unfsynced-writes!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-mount.21"><div class="inner"><span>mount!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-nemesis"><div class="inner"><span>nemesis</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-real-extension"><div class="inner"><span>real-extension</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-repo-url"><div class="inner"><span>repo-url</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-start-daemon.21"><div class="inner"><span>start-daemon!</span></div></a></li><li class="depth-1"><a href="jepsen.lazyfs.html#var-umount.21"><div class="inner"><span>umount!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.lazyfs</h1><div class="doc"><div class="markdown"><p>Lazyfs allows the injection of filesystem-level faults: specifically, losing data which was written to disk but not fsynced. This namespace lets you mount a specific directory as a lazyfs filesystem, and offers a DB which mounts/unmounts it, and downloads the lazyfs log file–this can be composed into your own database. You can then call lose-unfsynced-writes! as a part of your database’s db/kill! implementation, likely after killing your DB process itself.</p>
</div></div><div class="public anchor" id="var-bin"><h3>bin</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The lazyfs binary</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L34">view source</a></div></div><div class="public anchor" id="var-checkpoint.21"><h3>checkpoint!</h3><div class="usage"><code>(checkpoint! db-or-lazyfs-map)</code></div><div class="doc"><div class="markdown"><p>Forces the given lazyfs map or DB to flush writes to disk.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L253">view source</a></div></div><div class="public anchor" id="var-commit"><h3>commit</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>What version should we check out and build?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L26">view source</a></div></div><div class="public anchor" id="var-config"><h3>config</h3><div class="usage"><code>(config {:keys [fifo cache-size]})</code></div><div class="doc"><div class="markdown"><p>The lazyfs config file text. Takes a lazyfs map</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L42">view source</a></div></div><div class="public anchor" id="var-db"><h3>db</h3><div class="usage"><code>(db dir-or-lazyfs)</code></div><div class="doc"><div class="markdown"><p>Takes a directory or a lazyfs map and constructs a DB whose setup installs lazyfs and mounts the given lazyfs dir.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L237">view source</a></div></div><div class="public anchor" id="var-dir"><h3>dir</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where do we install lazyfs to on the remote node?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L30">view source</a></div></div><div class="public anchor" id="var-fifo.21"><h3>fifo!</h3><div class="usage"><code>(fifo! {:keys [user fifo]} cmd)</code></div><div class="doc"><div class="markdown"><p>Sends a string to the fifo channel for the given lazyfs map.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L214">view source</a></div></div><div class="public anchor" id="var-fuse-dev"><h3>fuse-dev</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>The path to the fuse device.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L38">view source</a></div></div><div class="public anchor" id="var-install.21"><h3>install!</h3><div class="usage"><code>(install!)</code></div><div class="doc"><div class="markdown"><p>Installs lazyfs on the currently-bound remote node.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L61">view source</a></div></div><div class="public anchor" id="var-lazyfs"><h3>lazyfs</h3><div class="usage"><code>(lazyfs x)</code></div><div class="doc"><div class="markdown"><p>Takes a directory as a string, or a map of options, or a full lazyfs map, which is passed through unaltered. Constructs a lazyfs map of all the files we need to run a lazyfs for a directory. Map options are:</p>
<p>:dir      The directory to mount :user     Which user should run lazyfs? Default “root”. :chown    Who to set as the owner of the directory. Defaults to “<user>:<user>” :cache-size  The size of the lazyfs page cache. Should be a string like “0.5GB”</user></user></p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L103">view source</a></div></div><div class="public anchor" id="var-lose-unfsynced-writes.21"><h3>lose-unfsynced-writes!</h3><div class="usage"><code>(lose-unfsynced-writes! db-or-lazyfs-map)</code></div><div class="doc"><div class="markdown"><p>Takes a lazyfs map or a lazyfs DB. Asks the local node to lose any writes to the given lazyfs map which have not been fsynced yet.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L243">view source</a></div></div><div class="public anchor" id="var-mount.21"><h3>mount!</h3><div class="usage"><code>(mount! {:keys [dir data-dir lazyfs-dir chown user config-file], :as lazyfs})</code></div><div class="doc"><div class="markdown"><p>Takes a lazyfs map, creates directories and config files, and starts the lazyfs daemon. You likely want to call this before beginning database setup. Returns the lazyfs map.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L163">view source</a></div></div><div class="public anchor" id="var-nemesis"><h3>nemesis</h3><div class="usage"><code>(nemesis lazyfs)</code></div><div class="doc"><div class="markdown"><p>A nemesis which inject faults into the given lazyfs map by writing to its fifo. Types of faults (:f) supported:</p>
<p>:lose-unfsynced-writes</p>
<pre><code>Forgets any writes which were not fsynced. The
:value should be a list of nodes you'd like to lose un-fsynced writes on.
</code></pre>
<p>You don’t necessarily need to use this–I haven’t figured out how to integrate it well into jepsen.nemesis combined. Once we start getting other classes of faults it will probably make sense for this nemesis to get more use and expand.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L262">view source</a></div></div><div class="public anchor" id="var-real-extension"><h3>real-extension</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>When we mount a lazyfs directory, it’s backed by a real directory on the underlying filesystem: e.g. ‘foo’ is backed by ‘foo.real’. We name this directory using this extension.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L55">view source</a></div></div><div class="public anchor" id="var-repo-url"><h3>repo-url</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Where can we clone lazyfs from?</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L22">view source</a></div></div><div class="public anchor" id="var-start-daemon.21"><h3>start-daemon!</h3><div class="usage"><code>(start-daemon! {:keys [dir lazyfs-dir data-dir pid-file log-file fifo config-file]})</code></div><div class="doc"><div class="markdown"><p>Starts the lazyfs daemon once preparation is complete. We daemonize ourselves so that we can get logs–also it looks like the built-in daemon might not work right now.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L145">view source</a></div></div><div class="public anchor" id="var-umount.21"><h3>umount!</h3><div class="usage"><code>(umount! {:keys [lazyfs-dir dir], :as lazyfs})</code></div><div class="doc"><div class="markdown"><p>Stops the given lazyfs map and destroys the lazyfs directory. You probably want to call this as a part of database teardown.</p>
</div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/v0.3.2/jepsen/src/jepsen/lazyfs.clj#L194">view source</a></div></div></div></body></html>